name: Build Firmware

on:
  push:
    tags:
      - "**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        working-directory: dashboard
        run: npm install

      - name: Build dashboard
        working-directory: dashboard
        run: npm run build

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Package dashboard
        run: |
          if [ -d data ] && [ "$(ls -A data)" ]; then
            cd data
            zip -r ../espwifi-dashboard-${{ steps.tag.outputs.tag }}.zip .
            cd ..
          fi

      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard
          path: espwifi-dashboard-*.zip
          retention-days: 90

  build-firmware:
    name: Build Firmware Binaries
    needs: build-dashboard
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # - environment: esp32
          #   chip: esp32
          #   baud: 460800
          #   bootloader_offset: "0x1000"
          # - environment: esp32-c3
          #   chip: esp32c3
          #   baud: 921600
          #   bootloader_offset: "0x0"
          - environment: esp32-s3
            chip: esp32s3
            baud: 921600
            bootloader_offset: "0x0"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download dashboard artifact
        uses: actions/download-artifact@v4
        with:
          name: dashboard

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Get tag name
        id: tag
        run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Generate SDK config for ${{ matrix.environment }}
        run: ./sdkconfigs/sdkconfig.sh ${{ matrix.environment }}

      - name: Build firmware for ${{ matrix.environment }}
        run: pio run --environment ${{ matrix.environment }}

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          TAG="${{ steps.tag.outputs.tag }}"
          ENV="${{ matrix.environment }}"
          
          # Copy the main firmware binary with new naming convention
          cp .pio/build/$ENV/firmware.bin artifacts/espwifi-firmware-${TAG}-${ENV}.bin
          
          # Copy partition table if it exists
          if [ -f .pio/build/$ENV/partitions.bin ]; then
            cp .pio/build/$ENV/partitions.bin artifacts/espwifi-partitions-${TAG}-${ENV}.bin
          fi
          
          # Copy bootloader if it exists
          if [ -f .pio/build/$ENV/bootloader.bin ]; then
            cp .pio/build/$ENV/bootloader.bin artifacts/espwifi-bootloader-${TAG}-${ENV}.bin
          fi
          
          # Create metadata file for this environment
          cat > artifacts/metadata-${ENV}.json << EOF
          {
            "environment": "${{ matrix.environment }}",
            "chip": "${{ matrix.chip }}",
            "baud": "${{ matrix.baud }}",
            "bootloader_offset": "${{ matrix.bootloader_offset }}"
          }
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.environment }}
          path: artifacts/*
          retention-days: 90

  create-release:
    name: Create Release
    needs: build-firmware
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Flatten the artifact directory structure
          find release-artifacts -type f -exec cp {} release/ \;
          
          VERSION="${GITHUB_REF_NAME}"
          
          # Read metadata from all built environments
          METADATA_FILES=(release/metadata-*.json)
          
          # Build arrays from metadata files
          ENVIRONMENTS=()
          CHIPS=()
          BAUDS=()
          OFFSETS=()
          
          for meta_file in "${METADATA_FILES[@]}"; do
            if [ -f "$meta_file" ]; then
              env=$(jq -r '.environment' "$meta_file")
              chip=$(jq -r '.chip' "$meta_file")
              baud=$(jq -r '.baud' "$meta_file")
              offset=$(jq -r '.bootloader_offset' "$meta_file")
              
              ENVIRONMENTS+=("$env")
              CHIPS+=("$chip")
              BAUDS+=("$baud")
              OFFSETS+=("$offset")
            fi
          done
          
          echo "Found ${#ENVIRONMENTS[@]} environments: ${ENVIRONMENTS[*]}"
          
          # Create a combined release notes file
          cat > release/FLASH_INSTRUCTIONS.md << 'FLASH_START'
          # ESPWiFi Firmware Flash Instructions
          
          This release contains firmware binaries for the following ESP32 variants:
          FLASH_START
          
          # Add environment list dynamically
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- ${env^^} ($env)" >> release/FLASH_INSTRUCTIONS.md
          done
          
          cat >> release/FLASH_INSTRUCTIONS.md << 'FLASH_CONTINUE'
          
          ## Prerequisites
          
          Install esptool.py if you haven't already:
          ```bash
          pip install esptool
          ```
          
          ## Flashing Instructions
          
          ### Option 1: Using esptool.py (Recommended for first flash)
          
          FLASH_CONTINUE
          
          # Generate flash instructions for each environment
          for i in "${!ENVIRONMENTS[@]}"; do
            env="${ENVIRONMENTS[$i]}"
            chip="${CHIPS[$i]}"
            baud="${BAUDS[$i]}"
            offset="${OFFSETS[$i]}"
            
            cat >> release/FLASH_INSTRUCTIONS.md << FLASH_ENV
          For **${env^^}**:
          \`\`\`bash
          esptool.py --chip ${chip} --port /dev/ttyUSB0 --baud ${baud} write_flash \\
            ${offset} espwifi-bootloader-${VERSION}-${env}.bin \\
            0x8000 espwifi-partitions-${VERSION}-${env}.bin \\
            0x10000 espwifi-firmware-${VERSION}-${env}.bin
          \`\`\`
          
          FLASH_ENV
          done
          
          cat >> release/FLASH_INSTRUCTIONS.md << 'FLASH_END'
          ### Option 2: Using npm scripts
          
          If you have the source code:
          ```bash
          cd dashboard && npm run upload
          ```
          
          ### Option 3: Firmware-only update (OTA)
          
          If you already have the bootloader and partition table flashed:
          ```bash
          esptool.py --chip auto --port /dev/ttyUSB0 write_flash 0x10000 espwifi-firmware-${VERSION}-<variant>.bin
          ```
          
          ## Troubleshooting
          
          - On macOS, replace `/dev/ttyUSB0` with `/dev/cu.usbserial-*` or similar
          - On Windows, use `COM3` or appropriate COM port
          - If flashing fails, try holding the BOOT button during the flash process
          - Ensure proper drivers are installed for your ESP32 board
          
          ## Notes
          
          - Always use the correct firmware for your specific ESP32 variant
          - Flash all three files (bootloader, partitions, firmware) for a clean install
          - For updates, flashing only the firmware.bin file is usually sufficient
          FLASH_END
          
          ls -lh release/

      - name: Extract release notes from tag
        id: release_notes
        run: |
          # Extract version from tag
          VERSION="${GITHUB_REF_NAME}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Read metadata from all built environments
          METADATA_FILES=(release/metadata-*.json)
          
          # Build arrays from metadata files
          ENVIRONMENTS=()
          CHIPS=()
          BAUDS=()
          OFFSETS=()
          
          for meta_file in "${METADATA_FILES[@]}"; do
            if [ -f "$meta_file" ]; then
              env=$(jq -r '.environment' "$meta_file")
              chip=$(jq -r '.chip' "$meta_file")
              baud=$(jq -r '.baud' "$meta_file")
              offset=$(jq -r '.bootloader_offset' "$meta_file")
              
              ENVIRONMENTS+=("$env")
              CHIPS+=("$chip")
              BAUDS+=("$baud")
              OFFSETS+=("$offset")
            fi
          done
          
          # Start release notes
          cat > release_notes.md << 'RELEASE_START'
          ## ESPWiFi Firmware ${VERSION}
          
          This release includes firmware binaries for:
          RELEASE_START
          
          # Add environment list dynamically
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- ${env^^}" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          cat >> release_notes.md << 'RELEASE_CONTINUE'
          See `FLASH_INSTRUCTIONS.md` for detailed flashing instructions.
          
          ### Files Included
          
          RELEASE_CONTINUE
          
          # Generate file list dynamically
          echo "**Firmware Binaries:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-firmware-${VERSION}-${env}.bin\` - ${env^^} firmware" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**Bootloaders:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-bootloader-${VERSION}-${env}.bin\` - ${env^^} bootloader" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**Partition Tables:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-partitions-${VERSION}-${env}.bin\` - ${env^^} partition table" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**Dashboard:**" >> release_notes.md
          echo "- \`espwifi-dashboard-${VERSION}.zip\` - Web dashboard UI (optional)" >> release_notes.md
          echo "" >> release_notes.md
          
          # Generate flash instructions dynamically
          cat >> release_notes.md << 'FLASH_START'
          ### Quick Flash
          
          Replace `/dev/ttyUSB0` with your serial port.
          
          FLASH_START
          
          for i in "${!ENVIRONMENTS[@]}"; do
            env="${ENVIRONMENTS[$i]}"
            chip="${CHIPS[$i]}"
            baud="${BAUDS[$i]}"
            offset="${OFFSETS[$i]}"
            
            cat >> release_notes.md << FLASH_CMD
          **${env^^}:**
          \`\`\`bash
          esptool.py --chip ${chip} --port /dev/ttyUSB0 --baud ${baud} write_flash \\
            ${offset} espwifi-bootloader-${VERSION}-${env}.bin \\
            0x8000 espwifi-partitions-${VERSION}-${env}.bin \\
            0x10000 espwifi-firmware-${VERSION}-${env}.bin
          \`\`\`
          
          FLASH_CMD
          done
          
          # Add final sections
          cat >> release_notes.md << 'FINAL'
          ### Using npm scripts
          
          ```bash
          cd dashboard && npm run upload
          ```
          
          ### Dashboard Upload (Optional)
          
          Extract `espwifi-dashboard-${VERSION}.zip` to the `data` directory, then:
          ```bash
          cd dashboard && npm run uploadfs
          ```
          FINAL

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
