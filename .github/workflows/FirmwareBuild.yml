name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

permissions:
  contents: write
  packages: write

jobs:
  docker-build:
    name: Call Docker BuildX
    uses: ./.github/workflows/DockerBuildX.yml
    secrets: inherit

  build-dashboard:
    name: Build Embedded Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        working-directory: dashboard
        run: npm install

      - name: Build dashboard
        working-directory: dashboard
        run: npm run build

      - name: Compute tag name
        id: tag
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          REF_NAME="${GITHUB_REF_NAME}"
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            # PR builds are tagged by PR number + short sha
            TAG="pr-${{ github.event.number }}-${SHORT_SHA}"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # For tags, keep tag name as-is
            TAG="${REF_NAME}"
          else
            # Branch pushes use branch-sha format
            TAG="${REF_NAME}-${SHORT_SHA}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Package dashboard
        run: |
          if [ -d data ] && [ "$(ls -A data)" ]; then
            cd data
            TAG="${{ steps.tag.outputs.tag }}"
            zip -r ../espwifi-dashboard-${TAG}.zip .
            cd ..
          fi

      - name: Upload dashboard artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard
          path: espwifi-dashboard-*.zip
          retention-days: 90

  build-firmware:
    name: Build Firmware Binaries for ${{ matrix.environment.name }}
    needs: build-dashboard
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # - environment: esp32
          #   chip: esp32
          #   baud: 460800
          #   bootloader_offset: "0x1000"
          # - environment: esp32-c3
          #   chip: esp32c3
          #   baud: 921600
          #   bootloader_offset: "0x0"
          - environment: esp32-s3
            chip: esp32s3
            baud: 921600
            bootloader_offset: "0x0"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download dashboard artifact
        uses: actions/download-artifact@v4
        with:
          name: dashboard

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Compute tag name
        id: tag
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          REF_NAME="${GITHUB_REF_NAME}"
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            # PR builds are tagged by PR number + short sha
            TAG="pr-${{ github.event.number }}-${SHORT_SHA}"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # For tags, keep tag name as-is
            TAG="${REF_NAME}"
          else
            # Branch pushes use branch-sha format
            TAG="${REF_NAME}-${SHORT_SHA}"
          fi
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Generate SDK config for ${{ matrix.environment.name }}
        run: ./sdkconfigs/sdkconfig.sh ${{ matrix.environment }}

      - name: Build firmware for ${{ matrix.environment.name }}
        run: pio run --environment ${{ matrix.environment }}

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          TAG="${{ steps.tag.outputs.tag }}"
          ENV="${{ matrix.environment }}"
          
          # Copy the main firmware binary with new naming convention: espwifi-[type]-[env]-[tag].ext
          cp .pio/build/$ENV/firmware.bin artifacts/espwifi-firmware-${ENV}-${TAG}.bin
          
          # Copy partition table if it exists
          if [ -f .pio/build/$ENV/partitions.bin ]; then
            cp .pio/build/$ENV/partitions.bin artifacts/espwifi-partitions-${ENV}-${TAG}.bin
          fi
          
          # Copy bootloader if it exists
          if [ -f .pio/build/$ENV/bootloader.bin ]; then
            cp .pio/build/$ENV/bootloader.bin artifacts/espwifi-bootloader-${ENV}-${TAG}.bin
          fi
          
          # Create metadata file for this environment
          cat > artifacts/metadata-${ENV}.json << EOF
          {
            "environment": "${{ matrix.environment }}",
            "chip": "${{ matrix.chip }}",
            "baud": "${{ matrix.baud }}",
            "bootloader_offset": "${{ matrix.bootloader_offset }}"
          }
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.environment }}
          path: artifacts/*
          retention-days: 90

  create-release:
    name: Create Release
    needs: build-firmware
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Flatten the artifact directory structure, excluding metadata files
          find release-artifacts -type f ! -name 'metadata-*.json' -exec cp {} release/ \;
          
          echo "Found ${#ENVIRONMENTS[@]} environments: ${ENVIRONMENTS[*]}"
          
          ls -lh release/

      - name: Extract release notes from tag
        id: release_notes
        run: |
          # Extract version from tag
          VERSION="${GITHUB_REF_NAME}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
          # Read metadata from all built environments (from artifacts, not release)
          METADATA_FILES=(release-artifacts/*/metadata-*.json)
          
          # Build arrays from metadata files
          ENVIRONMENTS=()
          CHIPS=()
          BAUDS=()
          OFFSETS=()
          
          for meta_file in "${METADATA_FILES[@]}"; do
            if [ -f "$meta_file" ]; then
              env=$(jq -r '.environment' "$meta_file")
              chip=$(jq -r '.chip' "$meta_file")
              baud=$(jq -r '.baud' "$meta_file")
              offset=$(jq -r '.bootloader_offset' "$meta_file")
              
              ENVIRONMENTS+=("$env")
              CHIPS+=("$chip")
              BAUDS+=("$baud")
              OFFSETS+=("$offset")
            fi
          done
          
          # Start release notes
          cat > release_notes.md << RELEASE_START
          ## ESPWiFi Firmware Release: ðŸŽ‰ ${VERSION} ðŸŽ‰
          
          ### ðŸ“¦ Packages For Environments:
          RELEASE_START
          
          # Add environment list dynamically
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- ${env^^}" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          cat >> release_notes.md << 'RELEASE_CONTINUE'

          
          RELEASE_CONTINUE
          
          # Generate file list dynamically
          echo "**ðŸ’½ Firmware Binaries:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-firmware-${env}-${VERSION}.bin\` - ${env^^} firmware" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**ðŸ“² Bootloaders:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-bootloader-${env}-${VERSION}.bin\` - ${env^^} bootloader" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**ðŸ’¾ Partition Tables:**" >> release_notes.md
          for env in "${ENVIRONMENTS[@]}"; do
            echo "- \`espwifi-partitions-${env}-${VERSION}.bin\` - ${env^^} partition table" >> release_notes.md
          done
          echo "" >> release_notes.md
          
          echo "**ðŸ–¥ï¸ Dashboard:**" >> release_notes.md
          echo "- \`espwifi-dashboard-${VERSION}.zip\` - Web dashboard UI (optional)" >> release_notes.md
          echo "" >> release_notes.md
          
          echo "**ðŸ³ Docker Images:**" >> release_notes.md
          echo "- \`ghcr.io/vekjja/espwifi:${VERSION}\` - Dashboard container image" >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
