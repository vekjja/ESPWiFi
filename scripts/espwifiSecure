#!/usr/bin/env bash
# ESPWiFi Secure Boot Management Script
# Supports:
#   gen_key [--out /filepath] - Generate a secure boot signing key
#   burn_efuse [--port /dev/ttyUSB0] - Burn secure boot eFuse (IRREVERSIBLE)

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
REQ_FILE="$ROOT_DIR/scripts/requirements.txt"
SCRIPTS_DIR="$ROOT_DIR/scripts"

info()  { printf "ℹ️  %s\n" "$*"; }
ok()    { printf "✅ %s\n" "$*"; }
warn()  { printf "⚠️  %s\n" "$*" >&2; }
error() { printf "❌ %s\n" "$*" >&2; exit 1; }

find_python() {
  if command -v python3 >/dev/null 2>&1; then
    printf "python3\n"; return
  fi
  if command -v python >/dev/null 2>&1; then
    printf "python\n"; return
  fi
  error "python3/python not found. Please install Python 3."
}

check_dependencies() {
  local py_bin="$1"
  if [ ! -f "$REQ_FILE" ]; then
    error "Requirements file not found: $REQ_FILE"
  fi

  local missing=()
  while IFS= read -r line || [ -n "$line" ]; do
    # Strip comments/whitespace, then test import of module name (hyphen -> underscore)
    line="${line%%#*}"
    line="$(printf "%s" "$line" | xargs)"
    [ -z "$line" ] && continue

    local pkg="${line%%[<>=]*}"
    [ -z "$pkg" ] && pkg="$line"
    local module="${pkg//-/_}"

    if ! "$py_bin" -c "import $module" >/dev/null 2>&1; then
      missing+=("$pkg")
    fi
  done < "$REQ_FILE"

  if [ ${#missing[@]} -eq 0 ]; then
    return
  fi

  info "Missing required dependencies: ${missing[*]}"
  info "Installing from requirements.txt..."

  # Try --user first (preferred)
  if "$py_bin" -m pip install --user --quiet --upgrade -r "$REQ_FILE" 2>/dev/null; then
    ok "Dependencies installed."
    return
  fi

  # If --user fails, check if it's the externally-managed-environment error
  local pip_output
  pip_output=$("$py_bin" -m pip install --user --quiet --upgrade -r "$REQ_FILE" 2>&1 || true)
  if echo "$pip_output" | grep -q "externally-managed-environment"; then
    warn "User installation blocked, trying with --break-system-packages..."
    if ! "$py_bin" -m pip install --break-system-packages --quiet --upgrade -r "$REQ_FILE"; then
      error "Failed to install dependencies. Please install manually:\n  $py_bin -m pip install --break-system-packages -r $REQ_FILE"
    fi
  else
    error "Failed to install dependencies. Please install manually:\n  $py_bin -m pip install --user -r $REQ_FILE"
  fi
  ok "Dependencies installed."
}

usage() {
  cat <<EOF
Usage: $0 <command> [options]

Commands:
  gen_key [--out /filepath]     Generate a secure boot signing key
  sign_binaries                 Sign bootloader and firmware binaries
  burn_efuse [--port /dev/ttyUSB0]  Burn secure boot eFuse (IRREVERSIBLE!)

Examples:
  $0 gen_key
  $0 gen_key --out /path/to/key.pem
  $0 sign_binaries
  $0 burn_efuse
  $0 burn_efuse --port /dev/cu.usbserial-0001
EOF
  exit 1
}

main() {
  if [ $# -eq 0 ]; then
    usage
  fi

  local command="$1"
  shift

  local py_bin
  py_bin="$(find_python)"
  check_dependencies "$py_bin"

  printf "\n"

  case "$command" in
    gen_key)
      exec "$py_bin" "$SCRIPTS_DIR/gen_keys.py" "$@"
      ;;
    sign_binaries)
      exec "$py_bin" "$SCRIPTS_DIR/sign_binaries.py"
      ;;
    burn_efuse)
      exec "$py_bin" "$SCRIPTS_DIR/burn_efuse.py" "$@"
      ;;
    *)
      error "Unknown command: $command"
      usage
      ;;
  esac
}

main "$@"

