#!/usr/bin/env bash
# ESPWiFi Secure Boot Management Script
# Supports:
#   gen_key [--out /filepath]          - Generate a secure boot signing key
#   burn_efuse [--port /dev/ttyUSB0]   - Burn secure boot and/or flash encryption eFuses

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
REQ_FILE="$ROOT_DIR/scripts/requirements.txt"
SCRIPTS_DIR="$ROOT_DIR/scripts"

info()  { printf "ℹ️  %s\n" "$*"; }
ok()    { printf "✅ %s\n" "$*"; }
warn()  { printf "⚠️  %s\n" "$*" >&2; }
error() { printf "❌ %s\n" "$*" >&2; exit 1; }

find_python() {
  if command -v python3 >/dev/null 2>&1; then
    printf "python3\n"; return
  fi
  if command -v python >/dev/null 2>&1; then
    printf "python\n"; return
  fi
  error "python3/python not found. Please install Python 3."
}

check_dependencies() {
  local py_bin="$1"
  if [ ! -f "$REQ_FILE" ]; then
    error "Requirements file not found: $REQ_FILE"
  fi

  local missing=()
  while IFS= read -r line || [ -n "$line" ]; do
    # Strip comments/whitespace, then test import of module name (hyphen -> underscore)
    line="${line%%#*}"
    line="$(printf "%s" "$line" | xargs)"
    [ -z "$line" ] && continue

    local pkg="${line%%[<>=]*}"
    [ -z "$pkg" ] && pkg="$line"
    local module="${pkg//-/_}"

    if ! "$py_bin" -c "import $module" >/dev/null 2>&1; then
      missing+=("$pkg")
    fi
  done < "$REQ_FILE"

  if [ ${#missing[@]} -eq 0 ]; then
    return
  fi

  info "Missing required dependencies: ${missing[*]}"
  info "Installing from requirements.txt..."

  # Try --user first (preferred)
  if "$py_bin" -m pip install --user --quiet --upgrade -r "$REQ_FILE" 2>/dev/null; then
    ok "Dependencies installed."
    return
  fi

  # If --user fails, check if it's the externally-managed-environment error
  local pip_output
  pip_output=$("$py_bin" -m pip install --user --quiet --upgrade -r "$REQ_FILE" 2>&1 || true)
  if echo "$pip_output" | grep -q "externally-managed-environment"; then
    warn "User installation blocked, trying with --break-system-packages..."
    if ! "$py_bin" -m pip install --break-system-packages --quiet --upgrade -r "$REQ_FILE"; then
      error "Failed to install dependencies. Please install manually:\n  $py_bin -m pip install --break-system-packages -r $REQ_FILE"
    fi
  else
    error "Failed to install dependencies. Please install manually:\n  $py_bin -m pip install --user -r $REQ_FILE"
  fi
  ok "Dependencies installed."
}

usage() {
  cat <<EOF
Usage: $0 <command> [options]

Commands:
  gen_key [--out /filepath]            Generate a secure boot signing key
  sign_binaries                        Sign bootloader and firmware binaries
  burn_efuse [--sb|--fe] [--port PORT] Burn secure boot and/or flash encryption eFuses (IRREVERSIBLE!)

Examples:
  $0 gen_key
  $0 gen_key --out /path/to/key.pem
  $0 sign_binaries
  $0 burn_efuse                         # burns secure boot and flash encryption (default)
  $0 burn_efuse --sb                    # burns only secure boot
  $0 burn_efuse --fe --port /dev/cu.usbserial-0001  # burns only flash encryption
EOF
  exit 1
}

main() {
  if [ $# -eq 0 ]; then
    usage
  fi

  local command="$1"
  shift

  local py_bin
  py_bin="$(find_python)"
  check_dependencies "$py_bin"

  printf "\n"

  burn_efuse_command() {
    local do_sb=0
    local do_fe=0
    local port=""
    local key=""

    while [ $# -gt 0 ]; do
      case "$1" in
        --sb|--secure-boot) do_sb=1; shift ;;
        --fe|--flash-encryption) do_fe=1; shift ;;
        --port) port="$2"; shift 2 ;;
        --key) key="$2"; shift 2 ;;
        *) error "Unknown burn_efuse option: $1" ;;
      esac
    done

    # Default to both if none specified
    if [ $do_sb -eq 0 ] && [ $do_fe -eq 0 ]; then
      do_sb=1
      do_fe=1
    fi

    local common_args=()
    [ -n "$port" ] && common_args+=(--port "$port")
    [ -n "$key" ] && common_args+=(--key "$key")

    if [ $do_sb -eq 1 ]; then
      if [ ${#common_args[@]} -gt 0 ]; then
        "$py_bin" "$SCRIPTS_DIR/burn_efuse_secure_boot.py" "${common_args[@]}"
      else
        "$py_bin" "$SCRIPTS_DIR/burn_efuse_secure_boot.py"
      fi
      printf "\n"
    fi

    if [ $do_fe -eq 1 ]; then
      if [ ${#common_args[@]} -gt 0 ]; then
        "$py_bin" "$SCRIPTS_DIR/burn_efuse_flash_encryption.py" "${common_args[@]}"
      else
        "$py_bin" "$SCRIPTS_DIR/burn_efuse_flash_encryption.py"
      fi
      printf "\n"
    fi
  }

  case "$command" in
    gen_key)
      exec "$py_bin" "$SCRIPTS_DIR/gen_keys.py" "$@"
      ;;
    sign_binaries)
      exec "$py_bin" "$SCRIPTS_DIR/sign_binaries.py"
      ;;
    burn_efuse)
      burn_efuse_command "$@"
      ;;
    *)
      error "Unknown command: $command"
      usage
      ;;
  esac
}

main "$@"

